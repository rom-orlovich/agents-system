.PHONY: help start up down restart logs test clean tunnel oauth health build rebuild env

# Load environment variables if they exist
-include infrastructure/docker/.env
export


# ngrok static domain - set this in your CLI or .env!
# Example: NGROK_DOMAIN=your-name.ngrok-free.app
NGROK_DOMAIN ?= 

# =============================================================================
# HELP
# =============================================================================

help:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘        ðŸ¤– AI Agent System - Claude Code CLI                  â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ðŸš€ MAIN COMMANDS"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo "  make start     - ðŸŽ¯ Setup + Build + Start (one command!)"
	@echo "  make up        - Start services"
	@echo "  make down      - Stop services"
	@echo "  make restart   - Restart services"
	@echo "  make logs      - View logs"
	@echo ""
	@echo "ðŸ”§ UTILITIES"
	@echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
	@echo "  make oauth     - Refresh OAuth credentials"
	@echo "  make env       - Edit .env file"
	@echo "  make health    - Health check"
	@echo "  make tunnel    - Start ngrok tunnel (Permanent URL!)"
	@echo "  make clean     - Cleanup everything"
	@echo ""

# =============================================================================
# ðŸš€ MAIN COMMANDS
# =============================================================================

# ðŸŽ¯ ONE COMMAND TO RULE THEM ALL
start:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘        ðŸš€ Starting AI Agent System                           â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@# Prerequisites
	@echo " Checking prerequisites..."
	@command -v docker >/dev/null 2>&1 || { echo "âŒ Docker required. Get it from https://docker.com"; exit 1; }
	@command -v claude >/dev/null 2>&1 || { echo "âš ï¸  Installing Claude CLI..."; npm install -g @anthropic-ai/claude-code; }
	@test -d ~/.claude || { echo "âŒ Run 'claude login' first"; exit 1; }
	@echo "âœ… Prerequisites OK"
	@echo ""
	@# Environment
	@test -f infrastructure/docker/.env || { echo "ðŸ“„ Creating .env..."; cp infrastructure/docker/.env.example infrastructure/docker/.env; }
	@# OAuth
	@echo "ðŸ”‘ Extracting OAuth credentials..."
	@./infrastructure/docker/extract-oauth.sh 2>/dev/null || echo "âš ï¸  OAuth failed, using API key if set"
	@echo ""
	@# Build & Start
	@echo "ï¿½ Building containers..."
	@cd infrastructure/docker && docker-compose build --quiet
	@echo "ðŸš€ Starting services..."
	@cd infrastructure/docker && docker-compose up -d
	@sleep 8
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘        âœ… System Ready!                                      â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘  ðŸ”— Webhook:  http://localhost:8000                          â•‘"
	@echo "â•‘  ï¿½ Health:   http://localhost:8000/health                   â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "  make logs    - View logs"
	@echo "  make tunnel  - Enable external webhooks"
	@echo ""

up:
	@echo "ðŸ”‘ Refreshing OAuth..."
	@./infrastructure/docker/extract-oauth.sh 2>/dev/null || true
	@echo "ðŸš€ Starting services..."
	@cd infrastructure/docker && docker-compose up -d
	@sleep 5
	@echo "âœ… Running at http://localhost:8000"

down:
	@echo "ðŸ›‘ Stopping..."
	@cd infrastructure/docker && docker-compose down
	@echo "âœ… Stopped"

restart: down up

logs:
	@cd infrastructure/docker && docker-compose logs -f

# =============================================================================
# ï¿½ UTILITIES
# =============================================================================

oauth:
	@echo "ï¿½ Extracting OAuth from Keychain..."
	@./infrastructure/docker/extract-oauth.sh

env:
	@test -f infrastructure/docker/.env || cp infrastructure/docker/.env.example infrastructure/docker/.env
	@nano infrastructure/docker/.env

health:
	@./scripts/health-check.sh

build:
	@cd infrastructure/docker && docker-compose build

rebuild: down clean build up

tunnel:
	@command -v ngrok >/dev/null 2>&1 || { echo "ðŸ“¦ Installing ngrok via Homebrew..."; brew install ngrok; }
	@if [ -z "$(NGROK_DOMAIN)" ]; then \
		echo "âŒ NGROK_DOMAIN is not set!"; \
		echo "Please set it: make tunnel NGROK_DOMAIN=your-name.ngrok-free.app"; \
		exit 1; \
	fi
	@echo ""
	@echo "ðŸŒ Webhook URLs (Permanent!):"
	@echo "  GitHub: https://$(NGROK_DOMAIN)/webhooks/github"
	@echo "  Jira:   https://$(NGROK_DOMAIN)/webhooks/jira"
	@echo "  Sentry: https://$(NGROK_DOMAIN)/webhooks/sentry"
	@echo ""
	@ngrok http --url $(NGROK_DOMAIN) 8000

test:
	@pytest tests/ -v

clean:
	@echo "ðŸ§¹ Cleaning..."
	@cd infrastructure/docker && docker-compose down -v --remove-orphans 2>/dev/null || true
	@docker system prune -f 2>/dev/null || true
	@find . -name "__pycache__" -type d -delete 2>/dev/null || true
	@find . -name "*.pyc" -delete 2>/dev/null || true
	@echo "âœ… Clean"
