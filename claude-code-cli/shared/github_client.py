"""GitHub API client wrapper."""

from typing import Optional
from github import Github, GithubException
from .config import settings


class GitHubClient:
    """GitHub API client."""

    def __init__(self, token: Optional[str] = None):
        """Initialize GitHub client.

        Args:
            token: GitHub personal access token (optional)
        """
        self.token = token or settings.GITHUB_TOKEN
        self.client = Github(self.token)

    def create_issue_comment(
        self,
        repo_name: str,
        issue_number: int,
        body: str
    ) -> bool:
        """Create a comment on an issue or PR.

        Args:
            repo_name: Repository name (owner/repo)
            issue_number: Issue or PR number
            body: Comment body

        Returns:
            True if successful
        """
        try:
            repo = self.client.get_repo(repo_name)
            issue = repo.get_issue(issue_number)
            issue.create_comment(body)
            return True
        except GithubException as e:
            print(f"Error creating GitHub comment: {e}")
            return False

    def get_pr_number_from_url(self, url: str) -> Optional[int]:
        """Extract PR number from GitHub URL.

        Args:
            url: GitHub PR URL

        Returns:
            PR number or None
        """
        try:
            # URL format: https://github.com/owner/repo/pull/123
            parts = url.rstrip("/").split("/")
            if "pull" in parts:
                return int(parts[parts.index("pull") + 1])
        except (ValueError, IndexError):
            pass
        return None

    def add_pr_approval_comment(
        self,
        pr_url: str,
        task_id: str
    ) -> bool:
        """Add approval instructions to PR.

        Args:
            pr_url: Pull request URL
            task_id: Task identifier

        Returns:
            True if successful
        """
        pr_number = self.get_pr_number_from_url(pr_url)
        if not pr_number:
            return False

        # Extract repo name from URL
        parts = pr_url.split("/")
        owner_idx = parts.index("github.com") + 1
        repo_name = f"{parts[owner_idx]}/{parts[owner_idx + 1]}"

        comment_body = f"""
## ðŸ¤– AI-Generated Fix Plan

This plan was automatically generated by the AI Agent System.

**Task ID:** `{task_id}`

### To Approve:
- Comment `@agent approve` on this PR
- Or approve via Slack
- Or approve via the Dashboard

### To Reject:
- Comment `@agent reject [reason]` on this PR
- Or reject via Slack/Dashboard

---
*Automated by Claude Code CLI*
"""

        return self.create_issue_comment(repo_name, pr_number, comment_body)
