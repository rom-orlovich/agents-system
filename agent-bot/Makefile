.PHONY: help init build up down restart logs test lint format clean

help:
	@echo "Agent Bot - Quick Commands"
	@echo ""
	@echo "Start:"
	@echo "  make start             Start system (checks prerequisites)"
	@echo "  make cli-claude        Start Claude CLI"
	@echo "  make cli-cursor        Start Cursor CLI"
	@echo ""
	@echo "Services:"
	@echo "  make up                Start all services"
	@echo "  make down              Stop all services"
	@echo "  make health            Check service health"
	@echo ""
	@echo "Development:"
	@echo "  make test              Run tests"
	@echo "  make lint              Run linting"
	@echo "  make format            Auto-format code"
	@echo ""
	@echo "Database:"
	@echo "  make db-migrate MSG=x  Create migration"
	@echo "  make db-upgrade        Apply migrations"

# Setup
init:
	@echo "Initializing project..."
	cp -n .env.example .env 2>/dev/null || true
	cd agent-engine-package && pip install -e ".[dev]"
	@echo "Done. Update .env with your API keys."

build:
	docker-compose build

# Start (with checks)
start:
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘        ğŸš€ Starting Agent Bot System                          â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“‹ Checking prerequisites..."
	@command -v docker >/dev/null 2>&1 || { echo "âŒ Docker required. Get it from https://docker.com"; exit 1; }
	@docker ps >/dev/null 2>&1 || { echo "âŒ Docker daemon not running. Start Docker Desktop."; exit 1; }
	@echo "âœ… Docker OK"
	@echo ""
	@echo "ğŸ“„ Checking environment..."
	@test -f .env || { echo "ğŸ“„ Creating .env..."; cp .env.example .env; }
	@echo "âœ… Environment file ready"
	@echo ""
	@echo "ğŸ”‘ Checking CLI credentials..."
	@if [ -d ~/.claude ] || grep -q "^ANTHROPIC_API_KEY=" .env 2>/dev/null; then \
		echo "âœ… Claude CLI credentials found"; \
	else \
		echo "âš ï¸  Claude CLI not configured (set ANTHROPIC_API_KEY in .env)"; \
	fi
	@if grep -q "^CURSOR_API_KEY=" .env 2>/dev/null; then \
		echo "âœ… Cursor API key found"; \
	else \
		echo "âš ï¸  Cursor API key not set (set CURSOR_API_KEY in .env)"; \
	fi
	@echo ""
	@echo "ğŸ”¨ Building containers..."
	@docker-compose build --quiet
	@echo "ğŸš€ Starting services..."
	@docker-compose up -d redis postgres
	@sleep 5
	@docker-compose up -d
	@sleep 5
	@echo ""
	@echo "ğŸ§ª Verifying services..."
	@curl -sf http://localhost:8000/health > /dev/null && echo "âœ… API Gateway" || echo "âš ï¸  API Gateway not ready"
	@curl -sf http://localhost:5000/api/health > /dev/null && echo "âœ… Dashboard API" || echo "âš ï¸  Dashboard API not ready"
	@docker-compose exec -T redis redis-cli ping > /dev/null 2>&1 && echo "âœ… Redis" || echo "âš ï¸  Redis not ready"
	@docker-compose exec -T postgres pg_isready -U agent > /dev/null 2>&1 && echo "âœ… PostgreSQL" || echo "âš ï¸  PostgreSQL not ready"
	@echo ""
	@echo "ğŸ§ª Testing CLI and logging to database..."
	@PROVIDER=$${CLI_PROVIDER:-claude}; \
	if [ "$$PROVIDER" = "claude" ]; then \
		if [ -f $$HOME/.claude/.credentials.json ]; then \
			docker-compose run --rm \
				-e DATABASE_URL=postgresql+asyncpg://agent:$${POSTGRES_PASSWORD:-agent}@postgres:5432/agent_system \
				-e CLI_PROVIDER=claude \
				-v $$HOME/.claude/.credentials.json:/root/.claude/.credentials.json:ro \
				cli python scripts/test_cli.py 2>/dev/null || echo "âš ï¸  CLI test skipped (no credentials)"; \
		elif grep -q "^ANTHROPIC_API_KEY=" .env 2>/dev/null; then \
			docker-compose run --rm \
				-e DATABASE_URL=postgresql+asyncpg://agent:$${POSTGRES_PASSWORD:-agent}@postgres:5432/agent_system \
				-e CLI_PROVIDER=claude \
				-e ANTHROPIC_API_KEY=$$(grep "^ANTHROPIC_API_KEY=" .env | cut -d'=' -f2-) \
				cli python scripts/test_cli.py 2>/dev/null || echo "âš ï¸  CLI test skipped"; \
		else \
			echo "âš ï¸  CLI test skipped (no credentials found)"; \
		fi; \
	elif [ "$$PROVIDER" = "cursor" ] && grep -q "^CURSOR_API_KEY=" .env 2>/dev/null; then \
		docker-compose run --rm \
			-e DATABASE_URL=postgresql+asyncpg://agent:$${POSTGRES_PASSWORD:-agent}@postgres:5432/agent_system \
			-e CLI_PROVIDER=cursor \
			-e CURSOR_API_KEY=$$(grep "^CURSOR_API_KEY=" .env | cut -d'=' -f2-) \
			cli python scripts/test_cli.py 2>/dev/null || echo "âš ï¸  CLI test skipped"; \
	fi
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘        âœ… System Ready!                                      â•‘"
	@echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
	@echo "â•‘  ğŸ”— API Gateway:   http://localhost:8000                     â•‘"
	@echo "â•‘  ğŸ“Š Dashboard:     http://localhost:5000                     â•‘"
	@echo "â•‘  ğŸ’š Health:        http://localhost:8000/health             â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Next steps:"
	@echo "  make cli-claude        Start Claude CLI"
	@echo "  make cli-cursor        Start Cursor CLI"
	@echo "  make health            Check all services"
	@echo ""

# Docker
up:
	docker-compose up -d

down:
	docker-compose down

# CLI Agent
cli-claude:
	@echo "Starting Claude CLI..."
	@echo "Ensuring shared Redis and PostgreSQL are running..."
	@docker-compose up -d redis postgres 2>/dev/null || true
	@sleep 3
	@echo "Ensuring shared network exists..."
	@docker network create agent-network 2>/dev/null || docker network inspect agent-network >/dev/null 2>&1 || docker-compose network create agent-network 2>/dev/null || true
	@echo "Building CLI container..."
	@CLI_PROVIDER=claude docker-compose -f docker-compose.cli.yml -p claude-cli --env-file .env build cli
	@echo "Calculating scale..."
	@EXISTING=$$(docker ps -a --filter "name=claude-cli-cli" --format "{{.Names}}" | wc -l | tr -d ' '); \
	if [ -n "$$SCALE" ]; then \
		TARGET_SCALE=$$SCALE; \
	elif [ "$$EXISTING" -gt 0 ]; then \
		TARGET_SCALE=$$((EXISTING + 1)); \
		echo "Found $$EXISTING existing container(s), scaling to $$TARGET_SCALE"; \
	else \
		TARGET_SCALE=1; \
	fi; \
	echo "Starting Claude CLI container(s) (scale: $$TARGET_SCALE)..."; \
	echo "Note: CLI test will run automatically in container entrypoint"; \
	CLI_PROVIDER=claude docker-compose -f docker-compose.cli.yml -p claude-cli --env-file .env up -d --scale cli=$$TARGET_SCALE cli
	@echo "âœ… Claude CLI started"
	@docker-compose -f docker-compose.cli.yml -p claude-cli ps cli
	@echo ""
	@echo "To view logs: make cli-claude-logs"

cli-cursor:
	@echo "Starting Cursor CLI..."
	@echo "Ensuring shared Redis and PostgreSQL are running..."
	@docker-compose up -d redis postgres 2>/dev/null || true
	@sleep 3
	@echo "Ensuring shared network exists..."
	@docker network create agent-network 2>/dev/null || docker network inspect agent-network >/dev/null 2>&1 || docker-compose network create agent-network 2>/dev/null || true
	@echo "Building CLI container..."
	@CLI_PROVIDER=cursor docker-compose -f docker-compose.cli.yml -p cursor-cli --env-file .env build cli
	@echo "Calculating scale..."
	@EXISTING=$$(docker ps -a --filter "name=cursor-cli-cli" --format "{{.Names}}" | wc -l | tr -d ' '); \
	if [ -n "$$SCALE" ]; then \
		TARGET_SCALE=$$SCALE; \
	elif [ "$$EXISTING" -gt 0 ]; then \
		TARGET_SCALE=$$((EXISTING + 1)); \
		echo "Found $$EXISTING existing container(s), scaling to $$TARGET_SCALE"; \
	else \
		TARGET_SCALE=1; \
	fi; \
	echo "Starting Cursor CLI container(s) (scale: $$TARGET_SCALE)..."; \
	echo "Note: CLI test will run automatically in container entrypoint"; \
	CLI_PROVIDER=cursor docker-compose -f docker-compose.cli.yml -p cursor-cli --env-file .env up -d --scale cli=$$TARGET_SCALE cli
	@echo "âœ… Cursor CLI started"
	@docker-compose -f docker-compose.cli.yml -p cursor-cli ps cli
	@echo ""
	@echo "To view logs: make cli-cursor-logs"

cli-claude-down:
	@echo "Stopping Claude CLI containers..."
	@if docker ps --format '{{.Names}}' | grep -q '^claude-cli-cli'; then \
		docker-compose -f docker-compose.cli.yml -p claude-cli down; \
	elif docker ps --format '{{.Names}}' | grep -q '^claude.*cli'; then \
		docker-compose -p claude down; \
	else \
		echo "No Claude CLI containers found"; \
	fi

cli-cursor-down:
	@echo "Stopping Cursor CLI containers..."
	@if docker ps --format '{{.Names}}' | grep -q '^cursor-cli-cli'; then \
		docker-compose -f docker-compose.cli.yml -p cursor-cli down; \
	elif docker ps --format '{{.Names}}' | grep -q '^cursor.*cli'; then \
		docker-compose -p cursor down; \
	else \
		echo "No Cursor CLI containers found"; \
	fi

cli-claude-logs:
	@docker-compose -f docker-compose.cli.yml -p claude-cli logs -f cli

cli-cursor-logs:
	@docker-compose -f docker-compose.cli.yml -p cursor-cli logs -f cli


# Testing
test:
	cd agent-engine-package && pytest

coverage:
	cd agent-engine-package && pytest --cov=agent_engine --cov-report=html

# Code Quality
lint:
	cd agent-engine-package && ruff check .

format:
	cd agent-engine-package && ruff format .

typecheck:
	cd agent-engine-package && mypy .

# Database
db-migrate:
	cd agent-engine-package && alembic revision --autogenerate -m "$(MSG)"

db-upgrade:
	cd agent-engine-package && alembic upgrade head

# Utilities
clean:
	find . -type d \( -name "__pycache__" -o -name ".pytest_cache" -o -name ".mypy_cache" -o -name ".ruff_cache" -o -name "*.egg-info" \) -exec rm -rf {} + 2>/dev/null || true

health:
	@echo "ğŸ” Checking services..."
	@curl -sf http://localhost:8000/health > /dev/null && echo "âœ… API Gateway" || echo "âŒ API Gateway"
	@curl -sf http://localhost:8080/health > /dev/null && echo "âœ… Agent Engine" || echo "âŒ Agent Engine"
	@curl -sf http://localhost:5000/api/health > /dev/null && echo "âœ… Dashboard API" || echo "âŒ Dashboard API"
	@curl -sf http://localhost:8090/health > /dev/null && echo "âœ… Task Logger" || echo "âŒ Task Logger"
	@docker-compose exec -T redis redis-cli ping > /dev/null 2>&1 && echo "âœ… Redis" || echo "âŒ Redis"
	@docker-compose exec -T postgres pg_isready -U agent > /dev/null 2>&1 && echo "âœ… PostgreSQL" || echo "âŒ PostgreSQL"
