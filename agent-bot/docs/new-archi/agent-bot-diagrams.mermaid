# Agent Bot - Architecture Diagrams

## 1. Multi-Organization Token Flow

```mermaid
sequenceDiagram
    participant Admin as Org Admin
    participant App as Your Agent App
    participant GH as GitHub
    participant DB as Database
    participant Agent as Agent Container

    Note over Admin,Agent: One-Time Setup (per org)
    Admin->>App: Click "Install App"
    App->>GH: OAuth Authorization
    GH->>App: Authorization Code
    App->>GH: Exchange for Tokens
    GH-->>App: access_token + refresh_token
    App->>DB: Store Installation(org_id, tokens)

    Note over Admin,Agent: Runtime (per webhook)
    GH->>App: Webhook (installation_id in payload)
    App->>DB: Get Installation(installation_id)
    DB-->>App: {access_token, webhook_secret}
    App->>App: Validate Signature
    App->>Agent: Task + access_token
    Agent->>GH: API calls with org's token
```

## 2. Ports & Adapters Architecture

```mermaid
graph TB
    subgraph Domain["Domain Core (Pure Python)"]
        TaskProcessor["Task Processor"]
        WorkflowEngine["Workflow Engine"]
        AgentOrchestrator["Agent Orchestrator"]
    end

    subgraph InputPorts["Input Ports"]
        WebhookPort["WebhookPort"]
        QueuePort["QueuePort"]
        CLIPort["CLIRunnerPort"]
    end

    subgraph OutputPorts["Output Ports"]
        DBPort["DatabasePort"]
        ExternalPort["ExternalServicePort"]
        LogPort["LoggerPort"]
    end

    subgraph InputAdapters["Input Adapters"]
        GitHubWH["GitHub Webhook"]
        JiraWH["Jira Webhook"]
        SlackWH["Slack Webhook"]
        RedisQ["Redis Queue"]
        SQSQ["SQS Queue"]
    end

    subgraph OutputAdapters["Output Adapters"]
        Postgres["PostgreSQL"]
        MongoDB["MongoDB"]
        ClaudeCLI["Claude CLI"]
        CursorCLI["Cursor CLI"]
        GitHubAPI["GitHub MCP"]
    end

    GitHubWH --> WebhookPort
    JiraWH --> WebhookPort
    SlackWH --> WebhookPort
    RedisQ --> QueuePort
    SQSQ --> QueuePort
    ClaudeCLI --> CLIPort
    CursorCLI --> CLIPort

    WebhookPort --> TaskProcessor
    QueuePort --> TaskProcessor
    TaskProcessor --> WorkflowEngine
    WorkflowEngine --> AgentOrchestrator
    AgentOrchestrator --> CLIPort

    TaskProcessor --> DBPort
    AgentOrchestrator --> ExternalPort
    WorkflowEngine --> LogPort

    DBPort --> Postgres
    DBPort --> MongoDB
    ExternalPort --> GitHubAPI
    LogPort --> StreamLog["Streaming Logger"]
```

## 3. Repository Cloning & Knowledge Graph Flow

```mermaid
flowchart TD
    subgraph Webhook["Webhook Received"]
        W1[GitHub PR Event]
        W2[Extract repo + PR number]
    end

    subgraph RepoManager["Repository Manager"]
        R1{Repo Cached?}
        R2[Clone Repository]
        R3[Update Repository]
        R4[Checkout PR Branch]
    end

    subgraph KnowledgeGraph["Knowledge Graph"]
        K1{Index Fresh?}
        K2[Parse Source Files]
        K3[Extract Entities]
        K4[Build Relations]
        K5[Store in Kuzu]
    end

    subgraph AgentExecution["Agent Execution"]
        A1[Query Graph for Context]
        A2[Read Files from Clone]
        A3[Run Analysis]
        A4[Generate Response]
    end

    W1 --> W2
    W2 --> R1
    R1 -->|No| R2
    R1 -->|Yes| R3
    R2 --> R4
    R3 --> R4
    R4 --> K1
    K1 -->|No| K2
    K1 -->|Yes| A1
    K2 --> K3 --> K4 --> K5 --> A1
    A1 --> A2 --> A3 --> A4
```

## 4. Agent Container Internal Architecture

```mermaid
graph TB
    subgraph AgentContainer["Agent Container"]
        subgraph Hooks["Lifecycle Hooks"]
            PreExec["pre-execution.md"]
            PostExec["post-execution.md"]
            OnError["on-error.md"]
        end

        subgraph Agents["Sub-Agents"]
            Planning["Planning Agent"]
            CodeReview["Code Review Agent"]
            BugFix["Bug Fix Agent"]
            Security["Security Scan Agent"]
            TestWriter["Test Writer Agent"]
        end

        subgraph Skills["Skills"]
            MCP["MCP Integration"]
            CodeAnalysis["Code Analysis"]
            GitOps["Git Operations"]
            KG["Knowledge Graph"]
            RepoCtx["Repo Context"]
        end

        subgraph Commands["Commands"]
            Analyze["@agent analyze"]
            Review["@agent review"]
            Fix["@agent fix"]
            Test["@agent test"]
        end

        subgraph Rules["Rules"]
            BestPractices["Best Practices"]
            SecurityRules["Security Rules"]
            Escalation["Escalation Rules"]
        end
    end

    Commands --> Planning
    Planning --> CodeReview
    Planning --> BugFix
    Planning --> Security
    Planning --> TestWriter

    CodeReview --> CodeAnalysis
    CodeReview --> KG
    BugFix --> GitOps
    BugFix --> KG
    Security --> CodeAnalysis
    TestWriter --> RepoCtx

    PreExec --> Planning
    PostExec --> MCP
    OnError --> Escalation
```

## 5. Complete System Architecture

```mermaid
flowchart TB
    subgraph External["External Services"]
        GitHub["GitHub"]
        Jira["Jira"]
        Slack["Slack"]
        Sentry["Sentry"]
    end

    subgraph Gateway["API Gateway :8080"]
        Webhooks["Webhook Handlers"]
        OAuth["OAuth Callbacks"]
        SigValid["Signature Validator"]
    end

    subgraph Infrastructure["Infrastructure"]
        Redis["Redis Queue"]
        Postgres["PostgreSQL"]
        RepoVol["Repo Volume"]
        GraphDB["Knowledge Graph"]
    end

    subgraph Agent["Agent Container"]
        Worker["Task Worker"]
        RepoMgr["Repo Manager"]
        GraphIdx["Graph Indexer"]
        CLI["CLI Runner"]
        Poster["Result Poster"]
    end

    subgraph MCP["MCP Servers"]
        GHMCP["GitHub MCP"]
        JiraMCP["Jira MCP"]
        SlackMCP["Slack MCP"]
        KGMCP["Knowledge Graph MCP"]
    end

    subgraph Dashboard["Dashboard :8090"]
        Logs["Log Viewer"]
        Analytics["Analytics"]
    end

    GitHub -->|Webhook| Webhooks
    Jira -->|Webhook| Webhooks
    Slack -->|Webhook| Webhooks
    Sentry -->|Webhook| Webhooks

    GitHub -->|OAuth| OAuth
    Jira -->|OAuth| OAuth
    Slack -->|OAuth| OAuth

    Webhooks --> SigValid
    SigValid --> Redis
    OAuth --> Postgres

    Redis --> Worker
    Worker --> RepoMgr
    RepoMgr --> RepoVol
    Worker --> GraphIdx
    GraphIdx --> GraphDB
    Worker --> CLI
    CLI --> Poster

    Poster --> GHMCP --> GitHub
    Poster --> JiraMCP --> Jira
    Poster --> SlackMCP --> Slack

    GraphDB --> KGMCP
    KGMCP --> CLI

    Redis --> Dashboard
    Postgres --> Dashboard
```

## 6. Webhook Extension Pattern

```mermaid
classDiagram
    class WebhookHandlerProtocol {
        <<interface>>
        +validate(payload, headers) bool
        +parse(payload) WebhookPayload
        +handle(payload) WebhookResponse
    }

    class WebhookRegistry {
        -handlers: dict
        +register(provider, handler)
        +get_handler(provider)
        +list_providers()
    }

    class GitHubWebhookHandler {
        +validate(payload, headers) bool
        +parse(payload) GitHubPayload
        +handle(payload) WebhookResponse
    }

    class JiraWebhookHandler {
        +validate(payload, headers) bool
        +parse(payload) JiraPayload
        +handle(payload) WebhookResponse
    }

    class LinearWebhookHandler {
        +validate(payload, headers) bool
        +parse(payload) LinearPayload
        +handle(payload) WebhookResponse
    }

    WebhookHandlerProtocol <|.. GitHubWebhookHandler
    WebhookHandlerProtocol <|.. JiraWebhookHandler
    WebhookHandlerProtocol <|.. LinearWebhookHandler

    WebhookRegistry --> WebhookHandlerProtocol : manages
```

## 7. Token Refresh Flow

```mermaid
sequenceDiagram
    participant Worker as Task Worker
    participant TokenSvc as Token Service
    participant DB as Database
    participant Provider as GitHub/Jira/Slack

    Worker->>TokenSvc: get_token(installation_id)
    TokenSvc->>DB: SELECT * FROM installations
    DB-->>TokenSvc: Installation record

    alt Token Expired
        TokenSvc->>Provider: POST /oauth/token (refresh_token)
        Provider-->>TokenSvc: New access_token
        TokenSvc->>DB: UPDATE installations SET access_token
    end

    TokenSvc-->>Worker: access_token
    Worker->>Provider: API call with token
```

## 8. Knowledge Graph Entity Model

```mermaid
erDiagram
    FILE ||--o{ FUNCTION : contains
    FILE ||--o{ CLASS : contains
    FILE ||--o{ IMPORT : has
    CLASS ||--o{ METHOD : contains
    CLASS ||--o{ CLASS : extends
    FUNCTION ||--o{ FUNCTION : calls
    METHOD ||--o{ FUNCTION : calls
    TEST ||--o{ FUNCTION : tests
    TEST ||--o{ METHOD : tests

    FILE {
        string path
        string module_name
        int line_count
        datetime last_modified
    }

    CLASS {
        string name
        int line_number
        string docstring
    }

    FUNCTION {
        string name
        int line_number
        string signature
        int complexity
    }

    METHOD {
        string name
        int line_number
        string visibility
    }

    IMPORT {
        string module
        string alias
        bool is_relative
    }

    TEST {
        string name
        string file_path
        string test_type
    }
```
