# GitHub Webhook Configuration
# ============================
# This file configures how the agent responds to GitHub events.
# Edit this file to customize commands, triggers, and behavior.

name: github
description: GitHub webhook for issues, PRs, and comments
endpoint: /webhooks/github
source: github

# Agent Trigger Configuration
# ---------------------------
# These are the prefixes that trigger the agent to respond.
# You can add aliases for alternative ways to trigger the agent.
agent_trigger:
  prefix: "@agent"
  aliases:
    - "@claude"
    - "@bot"
    - "@ai-agent"

# Default agent for routing tasks
target_agent: brain

# Default command when no specific command is detected
default_command: analyze

# Security Configuration
# ----------------------
security:
  requires_signature: true
  signature_header: X-Hub-Signature-256
  secret_env_var: GITHUB_WEBHOOK_SECRET

# Commands Configuration
# ----------------------
# Each command has:
#   - name: The primary command name
#   - aliases: Alternative names that trigger the same command
#   - description: Human-readable description
#   - target_agent: Which agent handles this command
#   - requires_approval: Whether human approval is needed
#   - prompt_template: The prompt sent to the agent (supports {{placeholders}})
commands:
  - name: analyze
    aliases:
      - analysis
      - analyze-issue
    description: Analyze an issue or PR
    target_agent: planning
    requires_approval: false
    prompt_template: |
      You are analyzing GitHub {{event_type}} #{{issue.number}} in repository {{repository.full_name}}.

      **Issue Title:** {{issue.title}}

      **User's Request:** {{_user_content}}

      **Full Comment/Description:**
      {{comment.body}}

      ---

      ## Your Task

      Perform a comprehensive analysis of this issue. If the user provided specific guidance in their request, focus on those aspects.

      ## Steps

      1. **Gather Information**
         - Use the `github-operations` skill to fetch full issue details, related PRs, and relevant code context
         - Read any referenced files or code sections mentioned in the issue
         - Check for similar issues or past discussions

      2. **Analyze**
         - Identify the root cause or core problem
         - Assess impact and severity
         - Consider potential solutions or approaches
         - Note any dependencies or blockers
         - If the user's request is unclear, identify what additional information is needed

      3. **Document Your Analysis**
         - Create a well-structured analysis document (analysis.md)
         - Use clear headings, bullet points, and code examples where relevant
         - Include your findings, recommendations, and next steps
         - If you need clarification, clearly state what questions you have

      4. **Post Response**
         - Use the github-operations skill to post your analysis back to the issue
         - Run: `python .claude/skills/github-operations/scripts/post_comment.py {{repository.owner.login}} {{repository.name}} {{issue.number}} analysis.md`

      ## Output Format

      Your analysis should include:
      - **Summary**: Brief overview of the issue
      - **Root Cause**: What's causing this problem?
      - **Impact**: Who/what is affected?
      - **Recommendations**: What should be done?
      - **Next Steps**: Clear actionable items

      Remember: Be thorough but concise. Focus on actionable insights.

  - name: plan
    aliases:
      - plan-fix
      - create-plan
    description: Create a plan to fix an issue
    target_agent: planning
    requires_approval: false
    prompt_template: |
      You are creating an implementation plan for GitHub issue #{{issue.number}} in {{repository.full_name}}.

      **Issue Title:** {{issue.title}}

      **User's Specific Request:** {{_user_content}}

      **Full Issue Description:**
      {{comment.body}}

      ---

      ## Your Task

      Create a detailed, actionable implementation plan. This plan will guide the executor agent, so be specific and thorough.

      ## Steps

      1. **Understand the Problem**
         - Use `github-operations` skill to fetch issue details, related code, and context
         - Use `Explore` agent (via Task tool) to understand the codebase structure
         - Identify all files that need changes

      2. **Design the Solution**
         - Break down the problem into logical steps
         - Consider edge cases and potential issues
         - Identify dependencies between changes
         - Plan for testing and verification
         - If the user gave specific constraints or preferences, incorporate them

      3. **Create the Plan Document**
         - Write a clear, structured plan (plan.md) with:
           - **Summary**: What will be implemented
           - **Approach**: High-level strategy
           - **Files to Modify**: List each file with specific changes
           - **Implementation Steps**: Numbered, sequential steps
           - **Testing Strategy**: How to verify the fix works
           - **Risks & Considerations**: Potential issues to watch for

      4. **Post the Plan**
         - Use github-operations skill to post the plan for review
         - Run: `python .claude/skills/github-operations/scripts/post_comment.py {{repository.owner.login}} {{repository.name}} {{issue.number}} plan.md`

      ## Plan Quality Guidelines

      - **Specific**: Avoid vague statements like "fix the bug" - explain exactly what needs to change
      - **Testable**: Include how to verify each step works
      - **Sequenced**: Order steps logically (dependencies first)
      - **Scoped**: Stay focused on the issue at hand
      - **Clear**: Use code examples where helpful

      Remember: The executor agent will follow your plan, so make it detailed and unambiguous.

  - name: fix
    aliases:
      - implement
      - execute
    description: Implement a fix for an issue
    target_agent: executor
    requires_approval: true
    prompt_template: |
      You are implementing a fix for GitHub issue #{{issue.number}} in {{repository.full_name}}.

      **Issue Title:** {{issue.title}}

      **User's Specific Instructions:** {{_user_content}}

      **Full Issue Description:**
      {{comment.body}}

      ---

      ## Your Task

      Implement the fix following Test-Driven Development (TDD) principles. Write code that solves the issue reliably.

      ## Steps

      1. **Understand the Requirements**
         - Use `github-operations` skill to fetch issue details and related discussions
         - Read the existing code to understand current behavior
         - If there's a plan (PLAN.md), follow it closely
         - If no plan exists, use `EnterPlanMode` to create one first

      2. **Follow TDD Workflow**
         - Write tests FIRST that capture the desired behavior
         - Run tests to confirm they fail (proving they test the issue)
         - Implement the minimal code to make tests pass
         - Refactor for quality while keeping tests green
         - Use the `testing` skill for test creation and execution

      3. **Implement the Fix**
         - Make focused changes that address the issue
         - Follow the codebase's existing patterns and style
         - Add proper error handling
         - Update documentation if needed
         - Keep changes minimal and targeted

      4. **Verify the Fix**
         - Run all tests (not just new ones)
         - Test manually if appropriate
         - Ensure no regressions
         - Use the `verification` skill for quality checks

      5. **Document Your Work**
         - Create a summary document (summary.md) with:
           - **What Was Fixed**: Brief description
           - **Changes Made**: List files modified and why
           - **Testing**: How you verified the fix
           - **Considerations**: Any edge cases or future improvements
         - Include before/after examples if helpful

      6. **Post the Summary**
         - Use github-operations skill to post your implementation summary
         - Run: `python .claude/skills/github-operations/scripts/post_comment.py {{repository.owner.login}} {{repository.name}} {{issue.number}} summary.md`

      ## Code Quality Standards

      - **Readable**: Clear variable names, logical flow
      - **Tested**: Comprehensive test coverage
      - **Safe**: Proper error handling, input validation
      - **Maintainable**: Follow existing patterns, add comments for complex logic
      - **Minimal**: Only change what's necessary

      Remember: This requires approval, so ensure your changes are well-tested and documented.

  - name: review
    aliases:
      - code-review
      - review-pr
    description: Review a pull request
    target_agent: planning
    requires_approval: false
    prompt_template: |
      You are reviewing pull request #{{pull_request.number}} in {{repository.full_name}}.

      **PR Title:** {{pull_request.title}}

      **User's Specific Focus:** {{_user_content}}

      **Full Comment:**
      {{comment.body}}

      ---

      ## IMPORTANT: Extract PR Details First

      Before running any commands, you MUST extract the PR number and repository info from task metadata:

      ```python
      import json
      metadata = json.loads(task.source_metadata)
      payload = metadata.get("payload", {})
      repo = payload.get("repository", {})
      owner = repo.get("owner", {}).get("login")
      repo_name = repo.get("name")
      pr = payload.get("pull_request", {})
      pr_number = pr.get("number")
      ```

      **DO NOT use template variables like {{pull_request.number}} in bash commands - they will not work!**
      **You MUST extract the actual values from task.source_metadata first.**

      ---

      ## Your Task

      Perform a thorough code review. If the user requested specific aspects to check (e.g., "check the scroll button"), prioritize those areas.

      ## Steps

      1. **Extract PR Details from Metadata**
         - Read `task.source_metadata` (JSON string)
         - Parse it to get: owner, repo_name, pr_number
         - Store these in variables for use in commands

      2. **Fetch PR Details**
         - Use github-operations skill to get PR details and changed files
         - Run: `python .claude/skills/github-operations/scripts/review_pr.py {owner} {repo_name} {pr_number}`
         - Replace {owner}, {repo_name}, {pr_number} with actual values extracted from metadata
         - This provides: changed files, diff, commit messages, PR description

      2. **Review the Code**
         - **Correctness**: Does the code do what it claims?
         - **Quality**: Is it well-structured, readable, maintainable?
         - **Security**: Any vulnerabilities or unsafe patterns?
         - **Performance**: Any obvious performance issues?
         - **Testing**: Are there tests? Do they cover edge cases?
         - **Documentation**: Are changes documented?
         - **User's Focus**: Address any specific concerns they mentioned

      3. **Check for Issues**
         - Logic errors or bugs
         - Missing error handling
         - Breaking changes
         - Inconsistent style
         - Unclear variable names
         - Code duplication

      4. **Create Review Document**
         - Write a structured review (review.md) with:
           - **Summary**: Overall assessment (approve/request changes/comment)
           - **Strengths**: What's done well
           - **Issues**: Problems found (categorized by severity)
           - **Suggestions**: Improvements (optional but helpful)
           - **Specific Feedback**: Line-by-line comments if needed
         - Be constructive and specific
         - Provide examples for suggested changes

      5. **Post the Review**
         - Use github-operations skill to post your review
         - Run: `python .claude/skills/github-operations/scripts/post_comment.py {owner} {repo_name} {pr_number} review.md`
         - Use the same variables extracted from metadata in step 1

      ## Review Tone

      - **Constructive**: Focus on improvement, not criticism
      - **Specific**: Reference exact files/lines/functions
      - **Educational**: Explain *why* something is an issue
      - **Appreciative**: Acknowledge good work

      Remember: Your goal is to improve code quality while supporting the developer.

  - name: approve
    aliases:
      - lgtm
      - approved
      - ship-it
    description: Approve a pull request or plan
    target_agent: executor
    requires_approval: false
    prompt_template: |
      Approval received for {{event_type}} in {{repository.full_name}}.

      **Approver's Comment:** {{_user_content}}

      **Full Comment:**
      {{comment.body}}

      ---

      ## Your Task

      Process this approval and proceed with execution if appropriate.

      ## Steps

      1. **Verify Approval Context**
         - Check what is being approved (plan, PR, implementation)
         - Review any conditions or notes in the approval comment
         - Ensure all required approvals are present

      2. **Check Readiness**
         - If this is a plan approval: Proceed with implementation
         - If this is a PR approval: Check if merge is possible (tests passing, no conflicts)
         - If this is a partial approval with conditions: Address those conditions first

      3. **Execute or Acknowledge**
         - **For Plan Approval**: Begin implementation using the `fix` command workflow
         - **For PR Approval**: If all checks pass, you may merge (check repo permissions)
         - **For Conditional Approval**: Note what needs to be addressed before proceeding

      4. **Document Action Taken**
         - Create a confirmation document (confirmation.md) stating:
           - What was approved
           - What action you're taking
           - Next steps or timeline
           - Any blockers or dependencies

      5. **Post Confirmation**
         - Use github-operations skill to post your response
         - Run: `python .claude/skills/github-operations/scripts/post_comment.py {{repository.owner.login}} {{repository.name}} {{issue.number}} confirmation.md`

      ## Important

      - Respect the approver's intent - if they added conditions, honor them
      - If you're unsure whether to proceed, ask for clarification
      - Document your actions clearly for transparency

      Remember: Approval is trust - proceed responsibly.

  - name: reject
    aliases:
      - changes-requested
      - request-changes
      - revise
    description: Request changes or reject a plan
    target_agent: planning
    requires_approval: false
    prompt_template: |
      Changes have been requested for {{event_type}} in {{repository.full_name}}.

      **Reviewer's Feedback:** {{_user_content}}

      **Full Comment:**
      {{comment.body}}

      ---

      ## Your Task

      Address the feedback and revise your previous work (plan or implementation).

      ## Steps

      1. **Understand the Feedback**
         - Carefully read all feedback points
         - Identify what needs to change
         - If feedback is unclear, ask clarifying questions using `AskUserQuestion` tool
         - Prioritize critical issues over minor suggestions

      2. **Gather Context**
         - Review the original issue/PR to understand initial requirements
         - Check your previous plan or implementation
         - Use `github-operations` skill to fetch any additional context needed

      3. **Revise Your Work**
         - Address each point of feedback systematically
         - For plan revisions: Update the plan with requested changes
         - For implementation revisions: Modify code to meet the new requirements
         - Explain *what* you changed and *why* in your revision

      4. **Create Revision Document**
         - Write a clear revision document (revised_plan.md or revised_implementation.md) with:
           - **Summary of Changes**: What you revised
           - **Feedback Addressed**: Show how each point was handled
           - **Reasoning**: Explain your approach to the changes
           - **Questions**: Any clarifications still needed
         - Mark sections that changed with REVISED labels

      5. **Post the Revision**
         - Use github-operations skill to post your revised work
         - Run: `python .claude/skills/github-operations/scripts/post_comment.py {{repository.owner.login}} {{repository.name}} {{issue.number}} revised_plan.md`
         - Tag the reviewer to request re-review

      ## Revision Quality

      - **Responsive**: Address every point of feedback
      - **Transparent**: Show what changed and why
      - **Improved**: Don't just make minimal changes - genuinely improve the work
      - **Humble**: Accept feedback graciously

      Remember: Feedback is an opportunity to improve. Take it seriously and produce better work.

  - name: improve
    aliases:
      - enhance
      - refactor
      - optimize
    description: Improve or refactor code
    target_agent: executor
    requires_approval: true
    prompt_template: |
      Code improvement requested in {{repository.full_name}}.

      **User's Improvement Request:** {{_user_content}}

      **Full Comment:**
      {{comment.body}}

      ---

      ## Your Task

      Improve the codebase while maintaining functionality. This could be refactoring, optimization, or enhancement.

      ## Steps

      1. **Understand the Improvement Request**
         - What specifically should be improved? (performance, readability, architecture, etc.)
         - What's the current state that needs improvement?
         - What are the success criteria?
         - If unclear, ask using `AskUserQuestion` tool

      2. **Analyze Current Code**
         - Use `Explore` agent to understand the code structure
         - Identify areas that match the improvement criteria
         - Look for patterns that need refactoring
         - Check for performance bottlenecks if optimization is the goal

      3. **Plan the Improvement**
         - Use `EnterPlanMode` to create an improvement plan
         - Consider impact on other parts of the codebase
         - Plan for backward compatibility if needed
         - Identify tests that need updating

      4. **Implement Improvements**
         - **Preserve Behavior**: Don't change what the code does, only how it does it
         - **Write Tests First**: Ensure existing tests pass, add new ones if needed
         - **Refactor Incrementally**: Make small, safe changes
         - **Maintain Style**: Follow existing code conventions
         - **Measure Impact**: For performance improvements, show before/after metrics

      5. **Types of Improvements**
         - **Refactoring**: Simplify logic, extract functions, reduce duplication
         - **Performance**: Optimize algorithms, reduce memory usage, improve speed
         - **Readability**: Better names, clearer structure, helpful comments
         - **Architecture**: Better separation of concerns, improved modularity
         - **Security**: Fix vulnerabilities, improve input validation
         - **Maintainability**: Reduce complexity, improve error handling

      6. **Document Improvements**
         - Create an improvement summary (improvement_summary.md) with:
           - **What Was Improved**: Specific areas changed
           - **Why**: Justification for each improvement
           - **Impact**: Benefits gained (faster, clearer, safer, etc.)
           - **Trade-offs**: Any drawbacks or considerations
           - **Before/After**: Examples showing the improvement
           - **Testing**: How you verified nothing broke

      7. **Post the Summary**
         - Use github-operations skill to post your improvement summary
         - Run: `python .claude/skills/github-operations/scripts/post_comment.py {{repository.owner.login}} {{repository.name}} {{issue.number}} improvement_summary.md`

      ## Improvement Principles

      - **Safety First**: Don't break existing functionality
      - **Test Coverage**: Ensure tests prove behavior is preserved
      - **Measurable**: Show concrete improvements (numbers, examples)
      - **Justified**: Explain why each change makes things better
      - **Incremental**: Make focused improvements, not massive rewrites

      Remember: Good improvements make code better without changing what it does.

  - name: help
    aliases:
      - commands
      - what-can-you-do
    description: Show available commands
    target_agent: brain
    requires_approval: false
    prompt_template: |
      User asked for help on GitHub issue #{{issue.number}} in {{repository.full_name}}.

      **User's Question:** {{_user_content}}

      Generate a helpful response listing available commands and how to use them.

      Available commands:
      - @agent analyze - Analyze an issue or PR
      - @agent plan - Create an implementation plan
      - @agent fix - Implement a fix (requires approval)
      - @agent review - Review a pull request
      - @agent approve - Approve a plan or PR
      - @agent reject - Request changes
      - @agent improve - Improve/refactor code (requires approval)
      - @agent help - Show this help message

      Post response using:
      python .claude/skills/github-operations/scripts/post_comment.py {{repository.owner.login}} {{repository.name}} {{issue.number}} help.md
